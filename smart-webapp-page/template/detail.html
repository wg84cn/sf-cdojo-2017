<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <title>集货详情</title>
    <meta name="viewport"
          content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no"/>
    <link rel="stylesheet" type="text/css" href="../css/mui.min.css"/>
    <link href="../css/app.css" rel="stylesheet"/>
    <link href="../css/detail.css" rel="stylesheet"/>
    <!--<script src="../../../../esg-clpp-webapp-20171009/esg-clpp-core-server_80002450/ngsoc-portal-webapp/src/main/webapp/assets/scripts/main.js"></script>-->
</head>
<body>
<div id="detail">
    <header class="mui-bar mui-bar-nav">
        <a class="mui-action-back back-btn mui-pull-left" href="../index.html">
            <img src="../images/Rectangle  Copy 4@2x.png" alt=""/>
        </a>
        <a class="mui-pull-left close-btn" href="../index.html">
            <img src="../images/返回 copy 2@2x.png" alt=""/>
        </a>
        <h1 class="mui-title f-h2">集货详情</h1>
        <a class="more-btn mui-pull-right" href="#">
            <img src="../images/更多 copy 2@2x.png" alt=""/>
        </a>
    </header>

    <nav class="mui-bar mui-bar-tab">
        <div class="share-wrapper">
            <img src="../images/分享 (3)@2x.png" alt="">
        </div>
        <div @tap="toMediaList">
            <a class="mui-btn mui-btn-warning dis-block join-now-wrapper" >
                <span class="mui-tab-label text-white">立即参加</span>
            </a>
        </div>
    </nav>

    <div class="mui-content">
        <div class="mui-card">
            <!--页眉，放置标题-->
            <div class="mui-card-header">
                <div class="title-wrapper">
                    <div class="title text-warning f-h1">{{mktNameShow}}</div>
                </div>
                <div class="sub-title f-h7">
                    <span>{{weightMin}}-{{weightMax}}kg</span>
                    <span>每日最低需寄<span class="text-warning">{{dailyMinPackages}}</span>件</span>
                </div>
            </div>
            <!--内容区-->
            <div class="mui-card-content">
                <img class="content-img" :src="storeMarketPic" alt=""/>
                <div class="badge">
                    <div class="badge-it">
                        <img class="content-img" src="../images/Group空 8.png" alt=""/>
                        <div class="badge-title">
                            <span class="f-h8 text-white">低至¥</span> <span class="f-h1 text-white">{{basePrice}}</span>
                            <br>
                            <span class="f-h8 text-white">{{weightMin}}kg</span>
                        </div>
                    </div>
                </div>
            </div>
            <!--页脚，放置补充信息或支持的操作-->
            <div class="mui-card-footer dis-block">
                <div class="dis-flex clearfix">
                    <div id="demo1" class="mui-progressbar btn-warning">
                        <span></span>
                        <div class="progress-number text-white f-h4">{{finishPercent}}%</span>
                        </div>

                    </div>
                    <div class="progress-word f-h3">
                        还差<span class="text-warning">{{groupLimit - storedNumber}}</span>人成团
                    </div>
                </div>
                <div class="deadline dis-block">
                    <!--截止日期: 8月14日-->
                    截止日期: {{deadline}}
                </div>
            </div>
        </div>

        <div class="mui-card">
            <div class="hint-wrapper">
                <div class="title f-h3">
                    <img src="../images/注意@2x.png" alt="">
                    <span>
                        使用要求
                    </span>
                </div>
                <div class="hint-content" v-html="userRequire">
                </div>
            </div>
        </div>

        <div class="mui-card">
            <div class="join-wrapper clearfix">
                <div class="title f-h3">
                    <img src="../images/参与@2x.png" alt="">
                    <span>最近参与</span>
                </div>
                <div class="hint-content">
                    <div class="favi-wrapper clearfix" v-for="icon in iconGroup">
                        <div class="favi-icon">
                            <img :src="icon.picUrl" alt="">
                        </div>
                    </div>
                    <div class="dis-block">

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="https://cdn.bootcss.com/vue/2.5.9/vue.min.js"></script>
<script src="../js/axios.min.js"></script>
<script src="../js/mui.min.js" type="text/javascript" charset="utf-8"></script>
<script src="../js/app.js" type="text/javascript" charset="utf-8"></script>
<script type="text/javascript">
    mui.init();
    var baseUrl = "";
//    var baseUrl = "http://192.168.0.1:9090";
//    var baseUrl = "http://www.mockhttp.cn/mock";
    var app = new Vue({
        el: '#detail',
        data: {
            "storeId":"",
            "storeMarketPic":"",
            "storedNumber":0,
            "marketId":"",
            "mktNameShow":"鞋服专送",
            "dailyMinPackages":0,
            "weightMin":0,
            "weightMax":0,
            "basePrice":0,
            "baseWeight":0,
            "groupLimit":0,
            "groupDuration":0,
            "userRequire":"",
            "createTime":0,
            "modifyTime":0,
            deadline: "",
            finishPercent: 0,
            iconGroup: [],
        },
        methods: {
            toMediaList: function () {
                mui.openWindow({
                    url: 'sentInformation.html',
                    id: 'info'
                });
            },
            butFuc: function (e) {
//						this.btnVal = '我被点击了'
                e.detail.gesture.preventDefault(); //修复iOS 8.x平台存在的bug，使用plus.nativeUI.prompt会造成输入法闪一下又没了
                var btnArray = ['取消', '确定'];
                mui.prompt('请输入你对MUI的评语：', '性能好', 'Hello MUI', btnArray, function (e) {
                    if (e.index == 1) {
                        info.innerText = '谢谢你的评语：' + e.value;
                    } else {
                        info.innerText = '你点了取消按钮';
                    }
                })
            },
            confirmFun: function (e) {
                var btnArray = ['否', '是'];
                mui.confirm('MUI是个好框架，确认？', 'Hello MUI', btnArray, function (e) {
//							console.log(e);
                    if (e.index == 1) {
                        info.innerText = '你刚确认MUI是个好框架';
                    } else {
                        info.innerText = 'MUI没有得到你的认可，继续加油'
                    }
                })
            },
            promise: function (op) {
                return axios(op.url + (op.append || ""), {params: op.data});
            },
            addData: function (data) {
                var dateReal;
                if( data.data.code === "200" && data.data.data ) {
                    dateReal = data.data.data;
                    dateReal.deadline = common.adjustTime( dateReal.createTime + dateReal.groupDuration * 60 * 1000, "MM月DD日");
                    dateReal.finishPercent = dateReal.storedNumber / dateReal.groupLimit || 0;

                    Object.keys( dateReal ).forEach(function (t) {
                        this[t] = dateReal[t];
                    }.bind(this));

                    this.userRequire = dateReal.userRequire.replace(/\$\{\{(\w+)\}\}/ig, function (match, cat) {
                        return "<span class='text-warning'> " + dateReal[cat] + "</span>";
                    }.bind(this));

                }
            },
            updatePro: function () {
                setInterval(function () {
                    this.init();
                }.bind(this), 1000 * 3)
            },
            addIcon:function (data) {
                var dateReal;
                if( data.data.code === "200" && data.data.data ) {
                    dateReal = data.data.data;
//                    this.$set("iconGroup", dateReal);
                    this.iconGroup = dateReal;
                }
            },
            sub: function (data){
                var that = this;
                var dataReal;
                if( data.data.code === "200" && data.data.data  && data.data.data.length ) {
                    dataReal = data.data.data;
                    window.localStorage.setItem("storeId", dataReal[0].storeId);
                    this.promise({
                        append: dataReal[0].storeId,
                        data: "",
                        url: baseUrl +  "/storeGoods/getStore/"
                    }).then(that.addData.bind(that))
                        .then(function () {
                            that.promise({
                                append: dataReal[0].storeId,
                                data: "",
                                url: baseUrl +  "/storeGoods/loadStoreUserList/"
                            }).then(that.addIcon.bind(that))
                        })


                }
            },
            init: function () {

                this.promise({
                    append: "",
                    data: "",
                    url: baseUrl +  "/storeGoods/loadActiveStoreList"
                }).then(this.sub.bind(this))


            }
        },
        mounted: function () {
            console.log('mounted');
            this.init.call(this, arguments);
            this.updatePro();
        },
    });
</script>
</body>
</html>
